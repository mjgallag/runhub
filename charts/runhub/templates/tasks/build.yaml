apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build
spec:
  params:
    - name: dockerfile-path
      type: string
    - name: context-path
      type: string
    - name: image
      type: string
    - name: image-tag
      type: string
    - name: cache-from-image-tag
      type: string
  workspaces:
    - name: src
  steps:
    - name: build
      image: moby/buildkit:v0.8.0@sha256:7fd25ca755852c8c982072eb602b2b16b843e4ed4205f8c9ed4b3c53db5ae16e
      securityContext:
        privileged: true
      script: |
        buildctl-daemonless.sh \
          build \
            --frontend dockerfile.v0 \
            --local 'dockerfile=$(workspaces.src.path)/$(params.dockerfile-path)' \
            --local 'context=$(workspaces.src.path)/$(params.context-path)' \
            --output 'type=image,name=$(params.image):$(params.image-tag),push=true' \
            --export-cache 'type=registry,mode=max,ref=$(params.image):cache-$(params.image-tag)' \
            --import-cache 'type=registry,"ref=$(params.image):cache-$(params.image-tag),$(params.image):cache-$(params.cache-from-image-tag)"'
