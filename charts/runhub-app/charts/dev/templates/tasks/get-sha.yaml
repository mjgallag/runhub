apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: get-sha
spec:
  params:
    - name: service
      type: string
    - name: tag
      type: string
  results:
    - name: sha
  steps:
    - name: get-sha
      image: quay.io/skopeo/upstream:latest@sha256:90915fde2466d5163d7ca518cbd2bbcfb45b245ae18131af3f5f01fd8ad23d0e
      script: |
        IMAGE='{{ template "runhub-app.dev.imagePathWithRegistry" . }}/$(params.service)'

        skopeo inspect "docker://${IMAGE:?}"':$(params.tag)' --format '{{"{{"}} .Digest }}' \
          | tr -d '\n' > '$(results.sha.path)'
